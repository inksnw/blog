<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>通过kube Router学习网络1 - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="inksnw" /><meta name="description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它" /><meta name="keywords" content="Hugo, theme, even" />


<meta name="robots" content="">






<meta name="generator" content="Hugo 0.115.3 with theme even" />


<link rel="canonical" href="http://inksnw.asuscomm.com:3001/post/%E9%80%9A%E8%BF%87kube-router%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%BB%9C1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.64c9b7f0254ed1aa365dc8e9acbb5c7241025dced4946314569cf2cc3d7aa917.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"  crossorigin="anonymous">
<link rel="stylesheet" href="/css/styles.css">


<meta property="og:title" content="通过kube Router学习网络1" />
<meta property="og:description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://inksnw.asuscomm.com:3001/post/%E9%80%9A%E8%BF%87kube-router%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%BB%9C1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-07-27T10:57:51+08:00" />
<meta property="article:modified_time" content="2023-07-27T17:19:54+08:00" />
<meta itemprop="name" content="通过kube Router学习网络1">
<meta itemprop="description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它"><meta itemprop="datePublished" content="2023-07-27T10:57:51+08:00" />
<meta itemprop="dateModified" content="2023-07-27T17:19:54+08:00" />
<meta itemprop="wordCount" content="5264">
<meta itemprop="keywords" content="cni," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="通过kube Router学习网络1"/>
<meta name="twitter:description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"></a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/rust/">
        <li class="mobile-menu-item">rust</li>
      </a><a href="/life/">
        <li class="mobile-menu-item">生活</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo"></a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/rust/">rust</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/life/">生活</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    

    <header class="post-header">
        <h1 class="post-title">通过kube Router学习网络1</h1>

        <div class="post-meta">
            <span class="post-time"> 2023-07-27 </span>
            
            <span class="more-meta"> 约 5264 字 更新于 2023-07-27
              <a class="article-tags" href=/tags/cni/>cni</a>
                </span>
            
        </div>
    </header>

    
<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#环境准备">环境准备</a>
          <ul>
            <li><a href="#路由信息">路由信息</a></li>
            <li><a href="#网卡信息">网卡信息</a></li>
            <li><a href="#iptables与ipvs">iptables与ipvs</a></li>
          </ul>
        </li>
        <li><a href="#安装插件">安装插件</a>
          <ul>
            <li><a href="#查看路由表">查看路由表</a></li>
            <li><a href="#查看网卡">查看网卡</a></li>
          </ul>
        </li>
        <li><a href="#操作验证">操作验证</a>
          <ul>
            <li><a href="#关闭网络策略功能">关闭网络策略功能</a></li>
            <li><a href="#删除节点">删除节点</a></li>
            <li><a href="#抓包查看bgp信息">抓包查看BGP信息</a></li>
          </ul>
        </li>
        <li><a href="#通信实现">通信实现</a>
          <ul>
            <li><a href="#网络信息">网络信息</a></li>
            <li><a href="#查看arp信息">查看arp信息</a></li>
            <li><a href="#网桥信息">网桥信息</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

    
    <div class="post-content">
        <p>一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了<code>kube-router</code> 这个项目, cni,bgp,ipvs全囊括了, 好吧就它了, 让我们一起把整个cni都梳理一遍</p>
<h2 id="环境准备">环境准备</h2>
<p>这里用<code>kubekey</code>快速安装k8s,搞一个快速重建的shell脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Step 1: Delete cluster</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 1: Deleting cluster...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;yes&#34;</span> <span class="p">|</span> kk delete cluster -f config-simple.yaml  <span class="c1"># 自动回复yes</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 1: Cluster deletion completed.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">HOSTS</span><span class="o">=(</span><span class="s2">&#34;node1&#34;</span> <span class="s2">&#34;node2&#34;</span> <span class="s2">&#34;node3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">COMMAND1</span><span class="o">=</span><span class="s2">&#34;ip link delete kube-dummy-if&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">COMMAND2</span><span class="o">=</span><span class="s2">&#34;ip link delete kube-bridge&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> HOST in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOSTS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">HOST</span><span class="si">}</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COMMAND1</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">HOST</span><span class="si">}</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COMMAND2</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;删除网卡完成&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2: Create cluster</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 2: Creating cluster...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;yes&#34;</span> <span class="p">|</span> kk create cluster -f config-simple.yaml --with-local-storage --skip-pull-images  <span class="c1"># 自动回复yes</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 2: Cluster creation completed.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pod -A
</span></span></code></pre></td></tr></table>
</div>
</div><p>config-simple.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubekey.kubesphere.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node1, address: 192.168.50.50, internalAddress: 192.168.50.50, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node2, address: 192.168.50.51, internalAddress: 192.168.50.51, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node3, address: 192.168.50.52, internalAddress: 192.168.50.52, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">roleGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">controlPlaneEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="l">lb.kubesphere.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubernetes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">autoRenewCerts</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">containerManager</span><span class="p">:</span><span class="w"> </span><span class="l">containerd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">disableKubeProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodelocaldns</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubekey</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">fake</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubeServiceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.233.0.0</span><span class="l">/18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">multusCNI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateRegistry</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespaceOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registryMirrors</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">insecureRegistries</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">addons</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>安装完成后, 可以看到一个没有<code>kube-proxy</code>,没有<code>cni</code>的集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node1:~# kubectl get pod -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-4pf2t                      0/1     Pending   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-5zw5f                      0/1     Pending   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-node1                          1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-node1                 1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-node1                          1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   openebs-localpv-provisioner-7cc4c84b9-t4gr4   0/1     Pending   <span class="m">0</span>          11m
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="路由信息">路由信息</h3>
<p>CNI (Container Network Interface) 的主要任务之一是确保不同主机上的容器网络能够互相通信。实现这一目标通常有两种方法：<code>overlay</code> 和 <code>underlay</code>。</p>
<p>在 <code>overlay</code> 网络中，网络包被封装在其他网络包中，然后通过底层的物理网络进行传输。这种方法对底层网络的要求较低，但可能会引入一些额外的性能开销。</p>
<p>相比之下，<code>underlay</code> 网络则直接利用底层的物理网络。在这种情况下，我们需要在路由表中添加路由规则，以确保数据包可以正确地路由到目标容器。然而，随着主机的变动，手动配置路由表通常是不切实际的。为了解决这个问题，我们可以使用 BGP (Border Gateway Protocol) 等动态路由协议，让路由器能够自动地学习和配置路由规则。</p>
<p>查看此时主机上的路由表, 并没有pod <code>cidr</code>相关的路由</p>
<blockquote>
<p>清空路由表命令 ip route flush table main , 注意清空可能导致无法远程连接, 重启后恢复一些默认的</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node1:~# route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="网卡信息">网卡信息</h3>
<p>CNI（Container Network Interface）插件的任务之一就是负责在容器中创建和配置网络接口。所以，当一个新的 Pod 被创建时，CNI 插件通常会在这个 Pod 的网络命名空间中添加一个或多个新的网络接口（也就是虚拟网卡）。</p>
<p>这些网络接口是 Pod 与外界通信的桥梁。每个接口都会被分配一个 IP 地址（通常来自节点的 Pod CIDR 范围）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@node1:~# ip addr
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span></span><span class="line"><span class="cl">    link/ether 52:54:00:34:d1:8a brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 192.168.50.50/24 brd 192.168.50.255 scope global dynamic enp1s0
</span></span><span class="line"><span class="cl">       valid_lft 74620sec preferred_lft 74620sec
</span></span><span class="line"><span class="cl">    inet6 fe80::5054:ff:fe34:d18a/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">root@node1:~# kubectl get pod -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-4hr6d                      0/1     Pending   0          3h9m
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-lngk8                      0/1     Pending   0          3h9m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-node1                          1/1     Running   0          3h9m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-node1                 1/1     Running   0          3h9m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-node1                          1/1     Running   0          3h9m
</span></span><span class="line"><span class="cl">kube-system   openebs-localpv-provisioner-7cc4c84b9-d5tpw   0/1     Pending   0          3h8m
</span></span><span class="line"><span class="cl">root@node1:~# kubectl get node
</span></span><span class="line"><span class="cl">NAME    STATUS     ROLES                  AGE    VERSION
</span></span><span class="line"><span class="cl">node1   NotReady   control-plane,worker   3h9m   v1.26.5
</span></span><span class="line"><span class="cl">node2   NotReady   worker                 3h9m   v1.26.5
</span></span><span class="line"><span class="cl">node3   NotReady   worker                 3h9m   v1.26.5
</span></span><span class="line"><span class="cl">root@node1:~# arp -n
</span></span><span class="line"><span class="cl">Address                  HWtype  HWaddress           Flags Mask            Iface
</span></span><span class="line"><span class="cl">192.168.50.51            ether   52:54:00:8b:47:fd   C                     enp1s0
</span></span><span class="line"><span class="cl">192.168.50.22            ether   40:ec:99:bb:84:b0   C                     enp1s0
</span></span><span class="line"><span class="cl">192.168.50.52            ether   52:54:00:19:ae:7d   C                     enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1             ether   24:4b:fe:d4:81:00   C                     enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="iptables与ipvs">iptables与ipvs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node1:~# iptables -L
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">KUBE-FIREWALL  all  --  anywhere             anywhere            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">KUBE-FIREWALL  all  --  anywhere             anywhere            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-FIREWALL <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DROP       all  -- !localhost/8          localhost/8          /* block incoming localnet connections */ ! ctstate RELATED,ESTABLISHED,DNAT
</span></span><span class="line"><span class="cl">DROP       all  --  anywhere             anywhere             /* kubernetes firewall <span class="k">for</span> dropping marked packets */ mark match 0x8000/0x8000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-KUBELET-CANARY <span class="o">(</span><span class="m">0</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">root@node1:~# ipvsadm
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装插件">安装插件</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --namespace<span class="o">=</span>kube-system create configmap kube-proxy  --from-file<span class="o">=</span>kubeconfig.conf<span class="o">=</span>/root/.kube/config
</span></span><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features-dsr.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看路由表">查看路由表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node1:~# route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.65.0     192.168.50.52   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Calico 的 IP 地址管理（IPAM）策略默认并不会为每个节点分配一个固定的 IP 地址范围。在默认情况下，Calico 会从一个全局的 CIDR 池中为每个新创建的 Pod 分配 IP 地址。这意味着一个节点上的 Pod 可以获得任何可用的 IP 地址，而不仅仅是来自某个特定的子网。</p>
</blockquote>
<p>在路由表中，主机 192.168.50.52 对应的 Pod CIDR 是 10.233.65.0/24，这意味着这个节点上的 Pod 可以使用的 IP 地址范围是 10.233.65.1 到 10.233.65.254。</p>
<p>实际环境中，受到各种因素的限制, 每个节点上可以运行的 Pod 数量可能会小于这个数字</p>
<h3 id="查看网卡">查看网卡</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@node1:~# ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span class="line"><span class="cl">    link/ether ea:87:60:eb:65:e8 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet6 fe80::e887:60ff:feeb:65e8/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">4: kube-dummy-if: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether aa:dc:35:92:2a:31 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.0.1/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet 10.233.0.3/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::a8dc:35ff:fe92:2a31/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="操作验证">操作验证</h2>
<h3 id="关闭网络策略功能">关闭网络策略功能</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># - --run-firewall=true改为false</span>
</span></span><span class="line"><span class="cl">kubectl edit ds kube-router -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看ipset信息, 此时即使创建网络策略, 也不会有效果, ipset结果中不会有网络策略相关的信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-basic" data-lang="basic"><span class="line"><span class="cl"><span class="vg">root@</span><span class="nl">node1:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="vg">ipset</span><span class="w"> </span><span class="o">--</span><span class="vg">list</span>
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="err">子网信息</span><span class="p">,</span><span class="w"> </span><span class="err">即上文的路由信息</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">pod</span><span class="o">-</span><span class="vg">subnets</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">net</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">6</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">736</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">2</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">10</span><span class="mf">.233.64.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.65.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.66.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="err">节点信息</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">node</span><span class="o">-</span><span class="vg">ips</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">ip</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">488</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">1</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span>
</span></span><span class="line"><span class="cl"><span class="nl">192</span><span class="mf">.168.50.51</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">192</span><span class="mf">.168.50.50</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">192</span><span class="mf">.168.50.52</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="err">本机信息</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">local</span><span class="o">-</span><span class="vg">ips</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">ip</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">392</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">1</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">2</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span>
</span></span><span class="line"><span class="cl"><span class="nl">127</span><span class="mf">.0.0.1</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">192</span><span class="mf">.168.50.50</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="vg">service</span><span class="w"> </span><span class="err">信息</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">service</span><span class="o">-</span><span class="vg">ips</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">ip</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">392</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">1</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">2</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.1</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.3</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="vg">svc</span><span class="err">转发信息</span><span class="p">,</span><span class="w"> </span><span class="mf">10.233.0.1</span><span class="w"> </span><span class="err">是</span><span class="vg">kubernetes</span><span class="err">的</span><span class="vg">clusterip</span><span class="p">,</span><span class="w"> </span><span class="mf">10.233.0.3</span><span class="err">是</span><span class="vg">coredns</span><span class="err">的</span><span class="vg">clusterip</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">ipvs</span><span class="o">-</span><span class="vg">services</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">ip</span><span class="p">,</span><span class="vg">port</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">5</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">576</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">1</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.1</span><span class="p">,</span><span class="nl">tcp:</span><span class="il">443</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.3</span><span class="p">,</span><span class="nl">tcp:</span><span class="il">53</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.3</span><span class="p">,</span><span class="nl">tcp:</span><span class="il">9153</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.0.3</span><span class="p">,</span><span class="nl">udp:</span><span class="il">53</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除节点">删除节点</h3>
<p>当前路由</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node1:~# route -n 
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.65.0     192.168.50.52   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除节点后, 可以看到, 相关的路由已被清理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl delete node node3
</span></span><span class="line"><span class="cl">root@node1:~# route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加回节点, 查看路由表可以看到已经添加了相关信息</p>
<blockquote>
<p>当你使用 <code>kubectl delete node &lt;node-name&gt;</code> 命令时，Kubernetes 会从集群状态中移除节点，但并不会停止节点上的 kubelet 服务。因此，当你重启 kubelet 服务时，kubelet 会尝试重新将节点注册到 Kubernetes 集群。这就是为什么重启 kubelet 会使节点自动加回来的原因。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl restart kubelet
</span></span><span class="line"><span class="cl">kubectl label nodes node3  node-role.kubernetes.io/worker<span class="o">=</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="抓包查看bgp信息">抓包查看BGP信息</h3>
<p>删除node3上的 <code>kube-router</code> pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl delete pod kube-router-nf9pb -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>在node1上抓包查看node3上的 <code>kube-router</code> pod被重新拉起的数据包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tcpdump -i any <span class="s1">&#39;port 179 and host 192.168.50.52&#39;</span> -v -n
</span></span><span class="line"><span class="cl">tcpdump: listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked v1<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">08:11:50.770802 IP <span class="o">(</span>tos 0x0, ttl 64, id 26890, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 60<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>S<span class="o">]</span>, cksum 0xe5e5 <span class="o">(</span>incorrect -&gt; 0x2d26<span class="o">)</span>, seq 3986906876, win 64240, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">3629793029</span> ecr 0,nop,wscale 10<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.771428 IP <span class="o">(</span>tos 0x0, ttl 255, id 0, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 60<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>S.<span class="o">]</span>, cksum 0xe5e5 <span class="o">(</span>incorrect -&gt; 0x96d6<span class="o">)</span>, seq 3060303424, ack 3986906877, win 65160, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">2666051348</span> ecr 3629793029,nop,wscale 10<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.771502 IP <span class="o">(</span>tos 0x0, ttl 64, id 26891, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc3ee<span class="o">)</span>, ack 1, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793030</span> ecr 2666051348<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.772053 IP <span class="o">(</span>tos 0x0, ttl 64, id 26892, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 122<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe623 <span class="o">(</span>incorrect -&gt; 0xf381<span class="o">)</span>, seq 1:71, ack 1, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793031</span> ecr 2666051348<span class="o">]</span>, length 70: BGP
</span></span><span class="line"><span class="cl">        Open Message <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">70</span>
</span></span><span class="line"><span class="cl">          Version 4, my AS 64512, Holdtime 90s, ID 192.168.50.50
</span></span><span class="line"><span class="cl">          Optional parameters, length: <span class="m">41</span>
</span></span><span class="line"><span class="cl">            Option Capabilities Advertisement <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">39</span>
</span></span><span class="line"><span class="cl">              Route Refresh <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">0</span>
</span></span><span class="line"><span class="cl">              Unknown <span class="o">(</span>73<span class="o">)</span>, length: <span class="m">7</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">73</span>
</span></span><span class="line"><span class="cl">                0x0000:  056e 6f64 <span class="m">6531</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">              Multiprotocol Extensions <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">              32-Bit AS Number <span class="o">(</span>65<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                 <span class="m">4</span> Byte AS <span class="m">64512</span>
</span></span><span class="line"><span class="cl">              Graceful Restart <span class="o">(</span>64<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                Restart Flags: <span class="o">[</span>none<span class="o">]</span>, Restart Time 90s
</span></span><span class="line"><span class="cl">                  AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>, Forwarding state preserved: no
</span></span><span class="line"><span class="cl">              Extended Next Hop Encoding <span class="o">(</span>5<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">5</span>
</span></span><span class="line"><span class="cl">                0x0000:  <span class="m">0001</span> <span class="m">0001</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">08:11:50.772597 IP <span class="o">(</span>tos 0x0, ttl 255, id 38615, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc3a5<span class="o">)</span>, ack 71, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051349</span> ecr 3629793031<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.772907 IP <span class="o">(</span>tos 0x0, ttl 255, id 38616, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 122<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe623 <span class="o">(</span>incorrect -&gt; 0x70b6<span class="o">)</span>, seq 1:71, ack 71, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051350</span> ecr 3629793031<span class="o">]</span>, length 70: BGP
</span></span><span class="line"><span class="cl">        Open Message <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">70</span>
</span></span><span class="line"><span class="cl">          Version 4, my AS 64512, Holdtime 90s, ID 192.168.50.52
</span></span><span class="line"><span class="cl">          Optional parameters, length: <span class="m">41</span>
</span></span><span class="line"><span class="cl">            Option Capabilities Advertisement <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">39</span>
</span></span><span class="line"><span class="cl">              Route Refresh <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">0</span>
</span></span><span class="line"><span class="cl">              Unknown <span class="o">(</span>73<span class="o">)</span>, length: <span class="m">7</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">73</span>
</span></span><span class="line"><span class="cl">                0x0000:  056e 6f64 <span class="m">6533</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">              Multiprotocol Extensions <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">              32-Bit AS Number <span class="o">(</span>65<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                 <span class="m">4</span> Byte AS <span class="m">64512</span>
</span></span><span class="line"><span class="cl">              Graceful Restart <span class="o">(</span>64<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                Restart Flags: <span class="o">[</span>R<span class="o">]</span>, Restart Time 90s
</span></span><span class="line"><span class="cl">                  AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>, Forwarding state preserved: yes
</span></span><span class="line"><span class="cl">              Extended Next Hop Encoding <span class="o">(</span>5<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">5</span>
</span></span><span class="line"><span class="cl">                0x0000:  <span class="m">0001</span> <span class="m">0001</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">08:11:50.772977 IP <span class="o">(</span>tos 0x0, ttl 64, id 26893, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc35e<span class="o">)</span>, ack 71, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793032</span> ecr 2666051350<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.773312 IP <span class="o">(</span>tos 0x0, ttl 255, id 38617, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 71<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe5f0 <span class="o">(</span>incorrect -&gt; 0xbf30<span class="o">)</span>, seq 71:90, ack 71, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051350</span> ecr 3629793031<span class="o">]</span>, length 19: BGP
</span></span><span class="line"><span class="cl">        Keepalive Message <span class="o">(</span>4<span class="o">)</span>, length: <span class="m">19</span>
</span></span><span class="line"><span class="cl">08:11:50.773359 IP <span class="o">(</span>tos 0x0, ttl 64, id 26894, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc34b<span class="o">)</span>, ack 90, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793032</span> ecr 2666051350<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.773866 IP <span class="o">(</span>tos 0x0, ttl 64, id 26895, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 71<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe5f0 <span class="o">(</span>incorrect -&gt; 0xbf1d<span class="o">)</span>, seq 71:90, ack 90, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793032</span> ecr 2666051350<span class="o">]</span>, length 19: BGP
</span></span><span class="line"><span class="cl">        Keepalive Message <span class="o">(</span>4<span class="o">)</span>, length: <span class="m">19</span>
</span></span><span class="line"><span class="cl">08:11:50.774194 IP <span class="o">(</span>tos 0x0, ttl 255, id 38618, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc336<span class="o">)</span>, ack 90, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051351</span> ecr 3629793032<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.774963 IP <span class="o">(</span>tos 0x0, ttl 64, id 26896, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe60d <span class="o">(</span>incorrect -&gt; 0x8263<span class="o">)</span>, seq 90:138, ack 90, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793034</span> ecr 2666051351<span class="o">]</span>, length 48: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">48</span>
</span></span><span class="line"><span class="cl">          Origin <span class="o">(</span>1<span class="o">)</span>, length: 1, Flags <span class="o">[</span>T<span class="o">]</span>: IGP
</span></span><span class="line"><span class="cl">          AS Path <span class="o">(</span>2<span class="o">)</span>, length: 0, Flags <span class="o">[</span>T<span class="o">]</span>: empty
</span></span><span class="line"><span class="cl">          Next Hop <span class="o">(</span>3<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: 192.168.50.50
</span></span><span class="line"><span class="cl">          Local Preference <span class="o">(</span>5<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: <span class="m">100</span>
</span></span><span class="line"><span class="cl">          Updated routes:
</span></span><span class="line"><span class="cl">            10.233.64.0/24
</span></span><span class="line"><span class="cl">08:11:50.775311 IP <span class="o">(</span>tos 0x0, ttl 255, id 38619, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc303<span class="o">)</span>, ack 138, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051352</span> ecr 3629793034<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.775656 IP <span class="o">(</span>tos 0x0, ttl 64, id 26897, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 75<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe5f4 <span class="o">(</span>incorrect -&gt; 0xc0ce<span class="o">)</span>, seq 138:161, ack 90, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793034</span> ecr 2666051352<span class="o">]</span>, length 23: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">23</span>
</span></span><span class="line"><span class="cl">          End-of-Rib Marker <span class="o">(</span>empty NLRI<span class="o">)</span>
</span></span><span class="line"><span class="cl">08:11:50.775929 IP <span class="o">(</span>tos 0x0, ttl 255, id 38620, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc2eb<span class="o">)</span>, ack 161, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051353</span> ecr 3629793034<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:51.777028 IP <span class="o">(</span>tos 0x0, ttl 255, id 38621, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe60d <span class="o">(</span>incorrect -&gt; 0x7c2c<span class="o">)</span>, seq 90:138, ack 161, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666052354</span> ecr 3629793034<span class="o">]</span>, length 48: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">48</span>
</span></span><span class="line"><span class="cl">          Origin <span class="o">(</span>1<span class="o">)</span>, length: 1, Flags <span class="o">[</span>T<span class="o">]</span>: IGP
</span></span><span class="line"><span class="cl">          AS Path <span class="o">(</span>2<span class="o">)</span>, length: 0, Flags <span class="o">[</span>T<span class="o">]</span>: empty
</span></span><span class="line"><span class="cl">          Next Hop <span class="o">(</span>3<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: 192.168.50.52
</span></span><span class="line"><span class="cl">          Local Preference <span class="o">(</span>5<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: <span class="m">100</span>
</span></span><span class="line"><span class="cl">          Updated routes:
</span></span><span class="line"><span class="cl">            10.233.68.0/24
</span></span><span class="line"><span class="cl">08:11:51.777029 IP <span class="o">(</span>tos 0x0, ttl 255, id 38622, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 75<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe5f4 <span class="o">(</span>incorrect -&gt; 0xbc9c<span class="o">)</span>, seq 138:161, ack 161, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666052354</span> ecr 3629793034<span class="o">]</span>, length 23: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">23</span>
</span></span><span class="line"><span class="cl">          End-of-Rib Marker <span class="o">(</span>empty NLRI<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到node1告诉了node3自己的pod子网段是<code>10.233.64.0/24</code>, node3告诉node1自己的pod子网段是<code>10.233.68.0/24</code></p>
<p>查看路由表确认</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@node1:~# route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    100    0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.68.0     192.168.50.52   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    100    0        0 enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>为什么每个节点的ip cidr范围掩码是24?</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 配置在这里</span>
</span></span><span class="line"><span class="cl">cat /etc/kubernetes/manifests/kube-controller-manager.yaml <span class="p">|</span>grep node-cidr-mask-size
</span></span><span class="line"><span class="cl">    - --node-cidr-mask-size<span class="o">=</span><span class="m">24</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="通信实现">通信实现</h2>
<h3 id="网络信息">网络信息</h3>
<p>创建一个pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run busybox --image<span class="o">=</span>busybox -- /bin/sh -c <span class="s2">&#34;while true; do sleep 3600; done&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">7: vethe5393dc7@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master kube-bridge state UP group default 
</span></span><span class="line"><span class="cl">    link/ether aa:f2:09:2c:26:2d brd ff:ff:ff:ff:ff:ff link-netns cni-c9f73dcd-802a-f008-f0e0-f052494c3d43
</span></span><span class="line"><span class="cl">    inet6 fe80::a8f2:9ff:fe2c:262d/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到veth网卡在宿主机的编号是7, 在容器里的编号是2, 我们进入容器看一下, 可以看到网卡编号与外部对应</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it busybox -- /bin/sh
</span></span><span class="line"><span class="cl">/ <span class="c1"># ip a</span>
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noqueue 
</span></span><span class="line"><span class="cl">    link/ether e6:c6:dc:64:bf:d9 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.68.4/24 brd 10.233.68.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::e4c6:dcff:fe64:bfd9/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看一下网桥信息, 可以看到kube-bridge上挂的接口<code>vethe5393dc7</code>与网卡名也能对应上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node3:~# brctl show
</span></span><span class="line"><span class="cl">bridge name     bridge id               STP enabled     interfaces
</span></span><span class="line"><span class="cl">kube-bridge             8000.4ae815f9f943       no              vethe5393dc7
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网络空间(containerd)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node3:~# ip netns
</span></span><span class="line"><span class="cl">cni-c9f73dcd-802a-f008-f0e0-f052494c3d43 <span class="o">(</span>id: 0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 连接查看</span>
</span></span><span class="line"><span class="cl">root@node3:~# ip netns <span class="nb">exec</span> cni-c9f73dcd-802a-f008-f0e0-f052494c3d43 ip addr
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default 
</span></span><span class="line"><span class="cl">    link/ether e6:c6:dc:64:bf:d9 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
</span></span><span class="line"><span class="cl">    inet 10.233.68.4/24 brd 10.233.68.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::e4c6:dcff:fe64:bfd9/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网络空间(docker)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#docker 环境执行结果</span>
</span></span><span class="line"><span class="cl">root@node-1:~# ls -l /var/run/netns
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#是因为docker创建在了这个目录 ls -l /var/run/docker/netns, 如果希望能用ip netns查看可以创建个链接过来</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="k">$(</span>ls /var/run/docker/netns<span class="k">)</span><span class="p">;</span> <span class="k">do</span> ln -s /var/run/docker/netns/<span class="nv">$i</span> /var/run/netns/<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果不想全链接过来, 可以参考 <a href="http://inksnw.asuscomm.com:3001/post/%E4%BD%BF%E7%94%A8nsenter%E8%B0%83%E8%AF%95%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C/">使用 nsenter 进入容器 netns </a>拿到pid</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ls -l /proc/$pid/ns/net /var/run/netns/docker_idxxx
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看arp信息">查看arp信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node3:~# brctl showmacs kube-bridge
</span></span><span class="line"><span class="cl">port no mac addr                is local?       ageing timer
</span></span><span class="line"><span class="cl">  <span class="m">1</span>     aa:f2:09:2c:26:2d       yes                0.00
</span></span><span class="line"><span class="cl">  <span class="m">1</span>     aa:f2:09:2c:26:2d       yes                0.00
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node3:~# brctl showstp kube-bridge
</span></span><span class="line"><span class="cl">kube-bridge
</span></span><span class="line"><span class="cl"> bridge id              8000.4ae815f9f943
</span></span><span class="line"><span class="cl"> designated root        8000.4ae815f9f943
</span></span><span class="line"><span class="cl"> root port                 <span class="m">0</span>                    path cost                  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> max age                  20.00                 bridge max age            20.00
</span></span><span class="line"><span class="cl"> hello <span class="nb">time</span>                2.00                 bridge hello <span class="nb">time</span>          2.00
</span></span><span class="line"><span class="cl"> forward delay            15.00                 bridge forward delay      15.00
</span></span><span class="line"><span class="cl"> ageing <span class="nb">time</span>             300.00
</span></span><span class="line"><span class="cl"> hello timer               0.00                 tcn timer                  0.00
</span></span><span class="line"><span class="cl"> topology change timer     0.00                 gc timer                 190.65
</span></span><span class="line"><span class="cl"> flags
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vethe5393dc7 <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id                <span class="m">8001</span>                    state                forwarding
</span></span><span class="line"><span class="cl"> designated root        8000.4ae815f9f943       path cost                  <span class="m">2</span>
</span></span><span class="line"><span class="cl"> designated bridge      8000.4ae815f9f943       message age timer          0.00
</span></span><span class="line"><span class="cl"> designated port        <span class="m">8001</span>                    forward delay timer        0.00
</span></span><span class="line"><span class="cl"> designated cost           <span class="m">0</span>                    hold timer                 0.00
</span></span><span class="line"><span class="cl"> flags
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>bridge id</code>: 是此桥的标识符，前四位是优先级，后面是桥的 MAC 地址。</li>
<li><code>designated root</code>: 是当前网络中选举出的根桥的 ID。</li>
<li><code>root port</code>: 是连接到根桥的端口。对于根桥，这个值是 0。</li>
<li><code>path cost</code>: 是到达根桥的代价，对于根桥，这个值是 0。</li>
<li><code>max age</code>, <code>hello time</code>, <code>forward delay</code> 以及 <code>ageing time</code> 都是 STP 的计时参数。</li>
<li><code>hello timer</code>, <code>tcn timer</code>, <code>topology change timer</code>, <code>gc timer</code> 是网桥维护的各种计时器。</li>
<li><code>flags</code> 是表示网桥当前状态的标志。</li>
</ol>
<p>接下来是网桥的每一个端口的详细信息，这些端口通常连接到其他网络设备。</p>
<ol>
<li><code>port id</code> 是端口的标识符，前四位是优先级，后面是端口号。</li>
<li><code>state</code> 是端口的状态，可能的值有 &ldquo;disabled&rdquo;, &ldquo;listening&rdquo;, &ldquo;learning&rdquo;, &ldquo;forwarding&rdquo; 和 &ldquo;blocking&rdquo;。</li>
<li><code>path cost</code> 是通过该端口到达根桥的代价。</li>
<li><code>designated root</code>, <code>designated bridge</code>, <code>designated port</code> 以及 <code>designated cost</code> 是此端口关于 STP 网络拓扑的信息。</li>
<li><code>message age timer</code>, <code>forward delay timer</code> 以及 <code>hold timer</code> 是此端口维护的计时器。</li>
<li><code>flags</code> 是表示端口当前状态的标志。</li>
</ol>
<h3 id="网桥信息">网桥信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@node3:~# bridge -d link
</span></span><span class="line"><span class="cl">3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> master kube-bridge kube-bridge
</span></span><span class="line"><span class="cl">7: vethe5393dc7@enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> master kube-bridge state forwarding priority <span class="m">32</span> cost <span class="m">2</span> 
</span></span><span class="line"><span class="cl">    hairpin off guard off root_block off fastleave off learning on flood on mcast_flood on mcast_to_unicast off neigh_suppress off vlan_tunnel off isolated off vethe5393dc7
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有两个设备的信息：<code>kube-bridge</code> 和 <code>vethe5393dc7</code>。每个设备的详细信息如下：</p>
<ol>
<li><code>3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master kube-bridge kube-bridge</code>:
<ul>
<li>这一行显示的是 <code>kube-bridge</code> 这个网桥的信息。它的编号是3。</li>
<li><code>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</code> 是设备的状态标志。<code>BROADCAST</code> 和 <code>MULTICAST</code> 说明这个设备支持广播和多播，<code>UP</code> 说明设备处于活跃状态，<code>LOWER_UP</code> 说明设备的物理链路处于活跃状态。</li>
<li><code>mtu 1500</code> 表示设备的最大传输单元（MTU）是 1500 字节。</li>
<li><code>master kube-bridge</code> 表示这个设备的主设备是 <code>kube-bridge</code>。</li>
</ul>
</li>
<li><code>7: vethe5393dc7@enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master kube-bridge state forwarding priority 32 cost 2</code>:
<ul>
<li>这一行显示的是 <code>vethe5393dc7</code> 这个设备的信息。它的编号是7，并且它与 <code>enp1s0</code> 设备关联（<code>@enp1s0</code>）。</li>
<li><code>state forwarding</code> 表示设备的状态是转发。</li>
<li><code>priority 32</code> 表示设备的优先级是 32。</li>
<li><code>cost 2</code> 表示设备的成本是 2，这通常用于路由选择。</li>
<li>后面的标志例如 <code>hairpin off</code>，<code>guard off</code>，<code>root_block off</code> 等，是针对网桥接口的特定设置。例如 <code>hairpin off</code> 表示关闭了发夹模式，这个模式决定了从一个网桥接口收到的数据是否可以在同一个接口上发送出去。</li>
</ul>
</li>
</ol>

    </div>

    
<footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/cni/">cni</a>
            </div>
        <nav class="post-nav">
            
            <a class="next" href="/post/cilium%E5%88%9D%E6%8E%A2/">
                <span class="next-text nav-default">Cilium初探</span>
                <span class="next-text nav-mobile">下一篇</span>
                <i class="iconfont icon-right"></i>
            </a>
        </nav>
    </footer>
</article>
        </div>
        

  

  

  
  

      </div>
    </main>

    <footer id="footer" class="footer">
      
<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy;
    2022 -
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>inksnw</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/slideout/1.0.1/slideout.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>






<script src="/js/scripts.js"></script>


</body>
</html>
