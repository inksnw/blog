<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>通过kube Router学习网络 - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="inksnw" /><meta name="description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它" /><meta name="keywords" content="Hugo, theme, even" />


<meta name="robots" content="">






<meta name="generator" content="Hugo 0.120.4 with theme even" />


<link rel="canonical" href="http://inksnw.asuscomm.com:3001/post/%E9%80%9A%E8%BF%87kube-router%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%BB%9C/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.64c9b7f0254ed1aa365dc8e9acbb5c7241025dced4946314569cf2cc3d7aa917.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"  crossorigin="anonymous">
<link rel="stylesheet" href="/css/styles.css">


<meta property="og:title" content="通过kube Router学习网络" />
<meta property="og:description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://inksnw.asuscomm.com:3001/post/%E9%80%9A%E8%BF%87kube-router%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%BB%9C/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-07-27T10:57:51+08:00" />
<meta property="article:modified_time" content="2023-07-27T10:57:51+08:00" />

<meta itemprop="name" content="通过kube Router学习网络">
<meta itemprop="description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它"><meta itemprop="datePublished" content="2023-07-27T10:57:51+08:00" />
<meta itemprop="dateModified" content="2023-07-27T10:57:51+08:00" />
<meta itemprop="wordCount" content="5821">
<meta itemprop="keywords" content="cni," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="通过kube Router学习网络"/>
<meta name="twitter:description" content="一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了kube-router 这个项目, cni,bgp,ipvs全囊括了, 好吧就它"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"></a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/rust/">
        <li class="mobile-menu-item">rust</li>
      </a><a href="/life/">
        <li class="mobile-menu-item">生活</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo"></a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/rust/">rust</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/life/">生活</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    

    <header class="post-header">
        <h1 class="post-title">通过kube Router学习网络</h1>

        <div class="post-meta">
            <span class="post-time"> 2023-07-27 </span>
            
            <span class="more-meta"> 约 5821 字 更新于 2023-07-27
              <a class="article-tags" href=/tags/cni/>cni</a>
                </span>
            
        </div>
    </header>

    
<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#环境准备">环境准备</a>
          <ul>
            <li><a href="#路由信息">路由信息</a></li>
          </ul>
        </li>
        <li><a href="#安装插件">安装插件</a>
          <ul>
            <li><a href="#查看路由表">查看路由表</a></li>
            <li><a href="#查看网卡">查看网卡</a></li>
          </ul>
        </li>
        <li><a href="#操作验证">操作验证</a>
          <ul>
            <li><a href="#删除节点">删除节点</a></li>
            <li><a href="#抓包查看bgp信息">抓包查看BGP信息</a></li>
            <li><a href="#修改为ipip">修改为ipip</a></li>
            <li><a href="#bgp信息查看">BGP信息查看</a></li>
          </ul>
        </li>
        <li><a href="#veth对实现">Veth对实现</a>
          <ul>
            <li><a href="#网络信息">网络信息</a></li>
            <li><a href="#查看arp信息">查看arp信息</a></li>
            <li><a href="#网桥信息">网桥信息</a></li>
          </ul>
        </li>
        <li><a href="#数据平面">数据平面</a>
          <ul>
            <li><a href="#pod到pod同主机">pod到pod(同主机)</a></li>
            <li><a href="#pod到pod不同主机">pod到pod(不同主机)</a></li>
            <li><a href="#pod到outside">pod到outside</a></li>
            <li><a href="#outside到svc到pod">outside到svc到pod</a></li>
            <li><a href="#pod到svc到pod">pod到svc到pod</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

    
    <div class="post-content">
        <p>一直以来想详细的梳理清楚cni这块, 但知识总是比较零碎, 恰好看到了<code>kube-router</code> 这个项目, <code>cni,bgp,ipvs</code>全囊括了, 好吧就它了, 让我们一起把整个cni都梳理一遍</p>
<h2 id="环境准备">环境准备</h2>
<p>这里用<code>kubekey</code>快速安装k8s,搞一个快速重建的shell脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Step 1: Delete cluster</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 1: Deleting cluster...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;yes&#34;</span> <span class="p">|</span> kk delete cluster -f config-simple.yaml  <span class="c1"># 自动回复yes</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 1: Cluster deletion completed.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">HOSTS</span><span class="o">=(</span><span class="s2">&#34;node1&#34;</span> <span class="s2">&#34;node2&#34;</span> <span class="s2">&#34;node3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">COMMAND1</span><span class="o">=</span><span class="s2">&#34;ip link delete kube-dummy-if&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">COMMAND2</span><span class="o">=</span><span class="s2">&#34;ip link delete kube-bridge&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> HOST in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOSTS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">HOST</span><span class="si">}</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COMMAND1</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">HOST</span><span class="si">}</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COMMAND2</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;删除网卡完成&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2: Create cluster</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 2: Creating cluster...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;yes&#34;</span> <span class="p">|</span> kk create cluster -f config-simple.yaml --with-local-storage --skip-pull-images  <span class="c1"># 自动回复yes</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Step 2: Cluster creation completed.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pod -A
</span></span></code></pre></td></tr></table>
</div>
</div><p>config-simple.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubekey.kubesphere.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node1, address: 192.168.50.50, internalAddress: 192.168.50.50, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node2, address: 192.168.50.51, internalAddress: 192.168.50.51, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: node3, address: 192.168.50.52, internalAddress: 192.168.50.52, user: root, password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">roleGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">controlPlaneEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="l">lb.kubesphere.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubernetes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">autoRenewCerts</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">containerManager</span><span class="p">:</span><span class="w"> </span><span class="l">containerd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">disableKubeProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodelocaldns</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubekey</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">fake</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubeServiceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.233.0.0</span><span class="l">/18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">multusCNI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateRegistry</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespaceOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registryMirrors</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">insecureRegistries</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">addons</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>安装完成后, 可以看到一个没有<code>kube-proxy</code>,没有<code>cni</code>的集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl get pod -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-4pf2t                      0/1     Pending   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   coredns-7f647946c8-5zw5f                      0/1     Pending   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-node1                          1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-node1                 1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-node1                          1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">kube-system   openebs-localpv-provisioner-7cc4c84b9-t4gr4   0/1     Pending   <span class="m">0</span>          11m
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="路由信息">路由信息</h3>
<p>CNI 的主要任务之一是确保不同主机上的容器网络能够互相通信。实现这一目标通常有两种方法：</p>
<ul>
<li>
<p><code>overlay</code> : 网络包被封装在其他网络包中，然后通过底层的物理网络进行传输。这种方法对底层网络的要求较低，但可能会引入一些额外的性能开销。</p>
</li>
<li>
<p><code>underlay</code> : 直接利用底层的物理网络。在这种情况下，我们需要在路由表中添加路由规则，以确保数据包可以正确地路由到目标容器。然而，随着主机的变动，手动配置路由表通常是不切实际的。为了解决这个问题，可以使用 BGP (Border Gateway Protocol) 等动态路由协议，让路由器能够自动地学习和配置路由规则。</p>
</li>
</ul>
<p>查看此时主机上的路由表, 并没有pod <code>cidr</code>相关的路由</p>
<blockquote>
<p>清空路由表命令 ip route flush table main , 注意清空可能导致无法远程连接, 重启后恢复一些默认的</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装插件">安装插件</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --namespace<span class="o">=</span>kube-system create configmap kube-proxy  --from-file<span class="o">=</span>kubeconfig.conf<span class="o">=</span>/root/.kube/config
</span></span><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features-dsr.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看路由表">查看路由表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.65.0     192.168.50.52   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>在路由表中，主机 192.168.50.52 对应的 Pod CIDR 是 10.233.65.0/24，这意味着这个节点上的 Pod 可以使用的 IP 地址范围是 10.233.65.1 到 10.233.65.254。</p>
<p>实际环境中，受到各种因素的限制, 每个节点上可以运行的 Pod 数量可能会小于这个数字</p>
<h3 id="查看网卡">查看网卡</h3>
<p>看到kube-router为主机新增了kube-bridge和kube-dummy-if网卡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜ ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span class="line"><span class="cl">    link/ether ea:87:60:eb:65:e8 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet6 fe80::e887:60ff:feeb:65e8/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">4: kube-dummy-if: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether aa:dc:35:92:2a:31 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.0.1/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet 10.233.0.3/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::a8dc:35ff:fe92:2a31/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="操作验证">操作验证</h2>
<h3 id="删除节点">删除节点</h3>
<p>当前路由</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ route -n 
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.65.0     192.168.50.52   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除节点后, 可以看到, 相关的路由已被清理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl delete node node3
</span></span><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加回节点, 查看路由表可以看到已经添加了相关信息</p>
<blockquote>
<p>当你使用 <code>kubectl delete node &lt;node-name&gt;</code> 命令时，Kubernetes 会从集群状态中移除节点，但并不会停止节点上的 kubelet 服务。因此，当你重启 kubelet 服务时，kubelet 会尝试重新将节点注册到 Kubernetes 集群。这就是为什么重启 kubelet 会使节点自动加回来的原因。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ systemctl restart kubelet
</span></span><span class="line"><span class="cl">➜ kubectl label nodes node3  node-role.kubernetes.io/worker<span class="o">=</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="抓包查看bgp信息">抓包查看BGP信息</h3>
<p>删除node3上的 <code>kube-router</code> pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜ kubectl delete pod kube-router-nf9pb -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>在node1上抓包查看node3上的 <code>kube-router</code> pod被重新拉起的数据包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ tcpdump -i any <span class="s1">&#39;port 179 and host 192.168.50.52&#39;</span> -v -n
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe623 <span class="o">(</span>incorrect -&gt; 0xf381<span class="o">)</span>, seq 1:71, ack 1, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793031</span> ecr 2666051348<span class="o">]</span>, length 70: BGP
</span></span><span class="line"><span class="cl">        Open Message <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">70</span>
</span></span><span class="line"><span class="cl">          Version 4, my AS 64512, Holdtime 90s, ID 192.168.50.50
</span></span><span class="line"><span class="cl">          Optional parameters, length: <span class="m">41</span>
</span></span><span class="line"><span class="cl">            Option Capabilities Advertisement <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">39</span>
</span></span><span class="line"><span class="cl">              Route Refresh <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">0</span>
</span></span><span class="line"><span class="cl">              Unknown <span class="o">(</span>73<span class="o">)</span>, length: <span class="m">7</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">73</span>
</span></span><span class="line"><span class="cl">                0x0000:  056e 6f64 <span class="m">6531</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">              Multiprotocol Extensions <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">              32-Bit AS Number <span class="o">(</span>65<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                 <span class="m">4</span> Byte AS <span class="m">64512</span>
</span></span><span class="line"><span class="cl">              Graceful Restart <span class="o">(</span>64<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                Restart Flags: <span class="o">[</span>none<span class="o">]</span>, Restart Time 90s
</span></span><span class="line"><span class="cl">                  AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>, Forwarding state preserved: no
</span></span><span class="line"><span class="cl">              Extended Next Hop Encoding <span class="o">(</span>5<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">5</span>
</span></span><span class="line"><span class="cl">                0x0000:  <span class="m">0001</span> <span class="m">0001</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">08:11:50.772597 IP <span class="o">(</span>tos 0x0, ttl 255, id 38615, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0xe5dd <span class="o">(</span>incorrect -&gt; 0xc3a5<span class="o">)</span>, ack 71, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051349</span> ecr 3629793031<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">08:11:50.772907 IP <span class="o">(</span>tos 0x0, ttl 255, id 38616, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 122<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe623 <span class="o">(</span>incorrect -&gt; 0x70b6<span class="o">)</span>, seq 1:71, ack 71, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666051350</span> ecr 3629793031<span class="o">]</span>, length 70: BGP
</span></span><span class="line"><span class="cl">        Open Message <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">70</span>
</span></span><span class="line"><span class="cl">          Version 4, my AS 64512, Holdtime 90s, ID 192.168.50.52
</span></span><span class="line"><span class="cl">          Optional parameters, length: <span class="m">41</span>
</span></span><span class="line"><span class="cl">            Option Capabilities Advertisement <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">39</span>
</span></span><span class="line"><span class="cl">              Route Refresh <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">0</span>
</span></span><span class="line"><span class="cl">              Unknown <span class="o">(</span>73<span class="o">)</span>, length: <span class="m">7</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">73</span>
</span></span><span class="line"><span class="cl">                0x0000:  056e 6f64 <span class="m">6533</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">              Multiprotocol Extensions <span class="o">(</span>1<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">              32-Bit AS Number <span class="o">(</span>65<span class="o">)</span>, length: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                 <span class="m">4</span> Byte AS <span class="m">64512</span>
</span></span><span class="line"><span class="cl">              Graceful Restart <span class="o">(</span>64<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                Restart Flags: <span class="o">[</span>R<span class="o">]</span>, Restart Time 90s
</span></span><span class="line"><span class="cl">                  AFI IPv4 <span class="o">(</span>1<span class="o">)</span>, SAFI Unicast <span class="o">(</span>1<span class="o">)</span>, Forwarding state preserved: yes
</span></span><span class="line"><span class="cl">              Extended Next Hop Encoding <span class="o">(</span>5<span class="o">)</span>, length: <span class="m">6</span>
</span></span><span class="line"><span class="cl">                no decoder <span class="k">for</span> Capability <span class="m">5</span>
</span></span><span class="line"><span class="cl">                0x0000:  <span class="m">0001</span> <span class="m">0001</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    192.168.50.50.54651 &gt; 192.168.50.52.179: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe60d <span class="o">(</span>incorrect -&gt; 0x8263<span class="o">)</span>, seq 90:138, ack 90, win 63, options <span class="o">[</span>nop,nop,TS val <span class="m">3629793034</span> ecr 2666051351<span class="o">]</span>, length 48: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">48</span>
</span></span><span class="line"><span class="cl">          Origin <span class="o">(</span>1<span class="o">)</span>, length: 1, Flags <span class="o">[</span>T<span class="o">]</span>: IGP
</span></span><span class="line"><span class="cl">          AS Path <span class="o">(</span>2<span class="o">)</span>, length: 0, Flags <span class="o">[</span>T<span class="o">]</span>: empty
</span></span><span class="line"><span class="cl">          Next Hop <span class="o">(</span>3<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: 192.168.50.50
</span></span><span class="line"><span class="cl">          Local Preference <span class="o">(</span>5<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: <span class="m">100</span>
</span></span><span class="line"><span class="cl">          Updated routes:
</span></span><span class="line"><span class="cl">            10.233.64.0/24
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    192.168.50.52.179 &gt; 192.168.50.50.54651: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0xe60d <span class="o">(</span>incorrect -&gt; 0x7c2c<span class="o">)</span>, seq 90:138, ack 161, win 64, options <span class="o">[</span>nop,nop,TS val <span class="m">2666052354</span> ecr 3629793034<span class="o">]</span>, length 48: BGP
</span></span><span class="line"><span class="cl">        Update Message <span class="o">(</span>2<span class="o">)</span>, length: <span class="m">48</span>
</span></span><span class="line"><span class="cl">          Origin <span class="o">(</span>1<span class="o">)</span>, length: 1, Flags <span class="o">[</span>T<span class="o">]</span>: IGP
</span></span><span class="line"><span class="cl">          AS Path <span class="o">(</span>2<span class="o">)</span>, length: 0, Flags <span class="o">[</span>T<span class="o">]</span>: empty
</span></span><span class="line"><span class="cl">          Next Hop <span class="o">(</span>3<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: 192.168.50.52
</span></span><span class="line"><span class="cl">          Local Preference <span class="o">(</span>5<span class="o">)</span>, length: 4, Flags <span class="o">[</span>T<span class="o">]</span>: <span class="m">100</span>
</span></span><span class="line"><span class="cl">          Updated routes:
</span></span><span class="line"><span class="cl">            10.233.68.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到node1告诉了node3自己的pod子网段是<code>10.233.64.0/24</code>, node3告诉node1自己的pod子网段是<code>10.233.68.0/24</code></p>
<p>查看路由表确认</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    100    0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     192.168.50.51   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.68.0     192.168.50.52   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    100    0        0 enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>为什么每个节点的ip cidr范围掩码是24?</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 配置在这里</span>
</span></span><span class="line"><span class="cl">➜ cat /etc/kubernetes/manifests/kube-controller-manager.yaml <span class="p">|</span>grep node-cidr-mask-size
</span></span><span class="line"><span class="cl">    - --node-cidr-mask-size<span class="o">=</span><span class="m">24</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="修改为ipip">修改为ipip</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 可选 full,subnet </span>
</span></span><span class="line"><span class="cl">➜ kubectl edit ds kube-router -n kube-system
</span></span><span class="line"><span class="cl">- --overlay-type<span class="o">=</span>full
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看路由表, 此时都变成了隧道模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tun-1921685051
</span></span><span class="line"><span class="cl">10.233.68.0     0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tun-1921685052
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网卡信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">6: tun-1921685052@enp1s0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu <span class="m">1480</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ipip 192.168.50.50 peer 192.168.50.52
</span></span><span class="line"><span class="cl">    inet6 fe80::5efe:c0a8:3232/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">7: tun-1921685051@enp1s0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu <span class="m">1480</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ipip 192.168.50.50 peer 192.168.50.51
</span></span><span class="line"><span class="cl">    inet6 fe80::5efe:c0a8:3232/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bgp信息查看">BGP信息查看</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl edit ds kube-router -n kube-system
</span></span><span class="line"><span class="cl">- --nodes-full-mesh<span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl <span class="nb">exec</span> -it kube-router-7l2mf -n kube-system -- /bin/sh
</span></span><span class="line"><span class="cl">➜ gobgp global
</span></span><span class="line"><span class="cl">AS:        <span class="m">64512</span>
</span></span><span class="line"><span class="cl">Router-ID: 192.168.50.50
</span></span><span class="line"><span class="cl">Listening Port: 179, Addresses: 192.168.50.50, ::1
</span></span><span class="line"><span class="cl">➜ gobgp neighbor
</span></span><span class="line"><span class="cl">Peer             AS  Up/Down State       <span class="p">|</span><span class="c1">#Received  Accepted</span>
</span></span><span class="line"><span class="cl">192.168.50.51 <span class="m">64512</span> 00:03:49 Establ      <span class="p">|</span>        <span class="m">1</span>         <span class="m">1</span>
</span></span><span class="line"><span class="cl">192.168.50.52 <span class="m">64512</span> 00:03:51 Establ      <span class="p">|</span>        <span class="m">1</span>         <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="veth对实现">Veth对实现</h2>
<h3 id="网络信息">网络信息</h3>
<p>创建一个pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl run busybox --image<span class="o">=</span>busybox -- /bin/sh -c <span class="s2">&#34;while true; do sleep 3600; done&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">7: vethe5393dc7@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master kube-bridge state UP group default 
</span></span><span class="line"><span class="cl">    link/ether aa:f2:09:2c:26:2d brd ff:ff:ff:ff:ff:ff link-netns cni-c9f73dcd-802a-f008-f0e0-f052494c3d43
</span></span><span class="line"><span class="cl">    inet6 fe80::a8f2:9ff:fe2c:262d/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到veth网卡在宿主机的编号是7, 在容器里的编号是2, 我们进入容器看一下, 可以看到网卡编号与外部对应</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl <span class="nb">exec</span> -it busybox -- /bin/sh
</span></span><span class="line"><span class="cl">➜ ip a
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noqueue 
</span></span><span class="line"><span class="cl">    link/ether e6:c6:dc:64:bf:d9 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.68.4/24 brd 10.233.68.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::e4c6:dcff:fe64:bfd9/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看一下网桥信息, 可以看到kube-bridge上挂的接口<code>vethe5393dc7</code>与网卡名也能对应上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ brctl show
</span></span><span class="line"><span class="cl">bridge name     bridge id               STP enabled     interfaces
</span></span><span class="line"><span class="cl">kube-bridge             8000.4ae815f9f943       no              vethe5393dc7
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网络空间(containerd)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ip netns
</span></span><span class="line"><span class="cl">cni-c9f73dcd-802a-f008-f0e0-f052494c3d43 <span class="o">(</span>id: 0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 连接查看</span>
</span></span><span class="line"><span class="cl">➜ ip netns <span class="nb">exec</span> cni-c9f73dcd-802a-f008-f0e0-f052494c3d43 ip addr
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default 
</span></span><span class="line"><span class="cl">    link/ether e6:c6:dc:64:bf:d9 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
</span></span><span class="line"><span class="cl">    inet 10.233.68.4/24 brd 10.233.68.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::e4c6:dcff:fe64:bfd9/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网络空间(docker)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#docker 环境执行结果</span>
</span></span><span class="line"><span class="cl">➜ ls -l /var/run/netns
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#是因为docker创建在了这个目录 ls -l /var/run/docker/netns, 如果希望能用ip netns查看可以创建个链接过来</span>
</span></span><span class="line"><span class="cl">➜ <span class="k">for</span> i in <span class="k">$(</span>ls /var/run/docker/netns<span class="k">)</span><span class="p">;</span> <span class="k">do</span> ln -s /var/run/docker/netns/<span class="nv">$i</span> /var/run/netns/<span class="nv">$i</span><span class="p">;</span> ➜ <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果不想全链接过来, 可以参考 <a href="http://inksnw.asuscomm.com:3001/post/%E4%BD%BF%E7%94%A8nsenter%E8%B0%83%E8%AF%95%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C/">使用 nsenter 进入容器 netns </a>拿到pid</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">➜</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">proc</span><span class="o">/$</span><span class="n">pid</span><span class="o">/</span><span class="n">ns</span><span class="o">/</span><span class="n">net</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">netns</span><span class="o">/</span><span class="n">docker_idxxx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看arp信息">查看arp信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ brctl showmacs kube-bridge
</span></span><span class="line"><span class="cl">port no mac addr                is local?       ageing timer
</span></span><span class="line"><span class="cl">  <span class="m">1</span>     aa:f2:09:2c:26:2d       yes                0.00
</span></span><span class="line"><span class="cl">  <span class="m">1</span>     aa:f2:09:2c:26:2d       yes                0.00
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="网桥信息">网桥信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ bridge -d link
</span></span><span class="line"><span class="cl">3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> master kube-bridge kube-bridge
</span></span><span class="line"><span class="cl">7: vethe5393dc7@enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> master kube-bridge state forwarding priority <span class="m">32</span> cost <span class="m">2</span> 
</span></span><span class="line"><span class="cl">    hairpin off guard off root_block off fastleave off learning on flood on mcast_flood on mcast_to_unicast off neigh_suppress off vlan_tunnel off isolated off vethe5393dc7
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有两个设备的信息：<code>kube-bridge</code> 和 <code>vethe5393dc7</code>。每个设备的详细信息如下：</p>
<ol>
<li><code>3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master kube-bridge kube-bridge</code>:
<ul>
<li>这一行显示的是 <code>kube-bridge</code> 这个网桥的信息。它的编号是3。</li>
<li><code>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</code> 是设备的状态标志。<code>BROADCAST</code> 和 <code>MULTICAST</code> 说明这个设备支持广播和多播，<code>UP</code> 说明设备处于活跃状态，<code>LOWER_UP</code> 说明设备的物理链路处于活跃状态。</li>
<li><code>mtu 1500</code> 表示设备的最大传输单元（MTU）是 1500 字节。</li>
<li><code>master kube-bridge</code> 表示这个设备的主设备是 <code>kube-bridge</code>。</li>
</ul>
</li>
<li><code>7: vethe5393dc7@enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master kube-bridge state forwarding priority 32 cost 2</code>:
<ul>
<li>这一行显示的是 <code>vethe5393dc7</code> 这个设备的信息。它的编号是7，并且它与 <code>enp1s0</code> 设备关联（<code>@enp1s0</code>）。</li>
<li><code>state forwarding</code> 表示设备的状态是转发。</li>
<li><code>priority 32</code> 表示设备的优先级是 32。</li>
<li><code>cost 2</code> 表示设备的成本是 2，这通常用于路由选择。</li>
<li>后面的标志例如 <code>hairpin off</code>，<code>guard off</code>，<code>root_block off</code> 等，是针对网桥接口的特定设置。例如 <code>hairpin off</code> 表示关闭了发夹模式，这个模式决定了从一个网桥接口收到的数据是否可以在同一个接口上发送出去。</li>
</ul>
</li>
</ol>
<h2 id="数据平面">数据平面</h2>
<h3 id="pod到pod同主机">pod到pod(同主机)</h3>
<img src="http://inksnw.asuscomm.com:3001/blog/通过kube-router学习网络1_52247654491a5c826a972cfff611648d.png" alt="image-20230728095909030" style="zoom:50%;" />
<p>创建两个同主机Pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l">node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">/bin/sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;while true; do sleep 3600; done&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE     IP             NODE    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">busybox1   1/1     Running   <span class="m">0</span>          9m40s   10.233.66.10   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">busybox2   1/1     Running   <span class="m">0</span>          9m25s   10.233.66.11   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">busybox3   1/1     Running   <span class="m">0</span>          7s      10.233.68.7    node3   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入容器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl <span class="nb">exec</span> -it busybox1 -- /bin/sh
</span></span><span class="line"><span class="cl"><span class="c1"># 查看arp -n 为空</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在node2宿主机上</span>
</span></span><span class="line"><span class="cl">➜ tcpdump -i kube-bridge arp
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on kube-bridge, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl"><span class="c1"># ping一下busybox2,可以看到`ttl`值为**64**, 并未减少, 说明未经过三层路由设备</span>
</span></span><span class="line"><span class="cl">➜ ping -c <span class="m">1</span> 10.233.66.11
</span></span><span class="line"><span class="cl">PING 10.233.66.11 <span class="o">(</span>10.233.66.11<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.233.66.11: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.260 ms
</span></span><span class="line"><span class="cl"><span class="c1"># 查看抓包信息</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on kube-bridge, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">02:22:25.035236 ARP, Request who-has 10.233.66.11 tell 10.233.66.10, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">02:22:25.035316 ARP, Reply 10.233.66.11 is-at 16:02:00:ed:e1:c2 <span class="o">(</span>oui Unknown<span class="o">)</span>, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">02:22:30.285761 ARP, Request who-has 10.233.66.10 tell 10.233.66.11, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">02:22:30.285838 ARP, Reply 10.233.66.10 is-at ce:75:23:68:89:32 <span class="o">(</span>oui Unknown<span class="o">)</span>, length <span class="m">28</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到通知了arp信息, 再次查看arp表</span>
</span></span><span class="line"><span class="cl">➜ arp -n
</span></span><span class="line"><span class="cl">? <span class="o">(</span>10.233.66.11<span class="o">)</span> at 16:02:00:ed:e1:c2 <span class="o">[</span>ether<span class="o">]</span>  on eth0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pod到pod不同主机">pod到pod(不同主机)</h3>
<p><img src="http://inksnw.asuscomm.com:3001/blog/%E9%80%9A%E8%BF%87kube-router%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%BB%9C1_f95047b417b24690ebe10a0de69b79da.png" alt="image-20230728104828121"></p>
<h4 id="ip-forward">ip-forward</h4>
<p>当前状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ sysctl -a<span class="p">|</span>grep net.ipv4.ip_forward
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 临时关闭</span>
</span></span><span class="line"><span class="cl">➜ sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>访问测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it busybox1 -- /bin/sh
</span></span><span class="line"><span class="cl">➜ ping -c <span class="m">1</span> 10.233.68.7  
</span></span><span class="line"><span class="cl">PING 10.233.68.7 <span class="o">(</span>10.233.68.7<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 10.233.68.7 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">0</span> packets received, 100% packet loss
</span></span><span class="line"><span class="cl"><span class="c1"># 打开再测试 sysctl -w net.ipv4.ip_forward=1</span>
</span></span><span class="line"><span class="cl">➜ ping -c <span class="m">1</span> 10.233.68.7  
</span></span><span class="line"><span class="cl">PING 10.233.68.7 <span class="o">(</span>10.233.68.7<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.233.68.7: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.836 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>关闭ip_forward的情况下, 分别抓包node2主机的<code>kube-bridge</code>,和<code>eth0(主网卡)</code></p>
<p>可以看到关闭了ip_forward后, kube-bridge有收到数据包, 但是enp1s0并没有收到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ tcpdump -i kube-bridge icmp
</span></span><span class="line"><span class="cl">02:38:52.272352 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 53, seq 0, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">02:40:45.095682 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 54, seq 0, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">02:40:46.095979 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 54, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">02:40:47.096254 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 54, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">02:40:48.096528 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 54, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">02:40:49.096815 IP 10.233.66.10 &gt; 10.233.68.7: ICMP <span class="nb">echo</span> request, id 54, seq 4, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">tcpdump -i enp1s0 icmp
</span></span><span class="line"><span class="cl">空
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="路由">路由</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl <span class="nb">exec</span> -it busybox1 -- /bin/sh
</span></span><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         10.233.66.1     0.0.0.0         UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> eth0
</span></span><span class="line"><span class="cl">10.233.66.0     0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> eth0
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个<code>10.233.66.1</code> 就是所在主机的<code>kube-bridge</code>的ip</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">3: kube-bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether fa:a8:05:23:99:d6 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.66.1/24 brd 10.233.66.255 scope global kube-bridge
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::f8a8:5ff:fe23:99d6/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pod到outside">pod到outside</h3>
<img src="http://inksnw.asuscomm.com:3001/blog/通过kube-router学习网络1_e415d248c4d6991e7217ca5117c3b79a.png" alt="image-20230728105027087" style="zoom:50%;" />
<p><strong>查看iptables规则</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ iptables-save
</span></span><span class="line"><span class="cl">-A POSTROUTING -m <span class="nb">set</span> --match-set kube-router-pod-subnets src -m <span class="nb">set</span> ! --match-set kube-router-pod-subnets dst -m <span class="nb">set</span> ! --match-set kube-router-node-ips dst -j MASQUERADE --random-fully
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>-A POSTROUTING</code>：这部分表示该规则将被添加（-A）到iptables的POSTROUTING链中。这是在路由决策后对报文进行最后处理的链。</li>
<li><code>-m set --match-set kube-router-pod-subnets src</code>：使用set模块（-m set）来匹配来源IP地址（src）是否在&quot;kube-router-pod-subnets&quot;各个Pod的子网集合中。</li>
<li><code>-m set ! --match-set kube-router-pod-subnets dst</code>：使用set模块来匹配目标IP地址（dst）是否<strong>不在</strong>&ldquo;kube-router-pod-subnets&quot;集合中。</li>
<li><code>-m set ! --match-set kube-router-node-ips dst</code>：使用set模块来匹配目标IP地址（dst）是否<strong>不在</strong>&ldquo;kube-router-node-ips&quot;各个节点集合中。</li>
<li><code>-j MASQUERADE --random-fully</code>：如果以上的所有条件都匹配，就对该包进行伪装（MASQUERADE）。&ldquo;MASQUERADE&quot;目标会在源地址变换(SNAT)时将报文的源IP地址更改为iptables所在主机的接口IP。&rdquo;&ndash;random-fully&quot;选项使得伪装的IP和端口随机分配，可以解决并发连接冲突的问题。</li>
</ol>
<p>简单来说，这个规则主要用于处理Kubernetes Pod到外部的出站流量，使用伪装来确保正确的网络通信。</p>
<p>那这些 <code>kube-router-pod-subnets </code> 的具体值是什么, 可以通过ipset查看</p>
<blockquote>
<p>ipset &ndash;list 查看全部</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-basic" data-lang="basic"><span class="line"><span class="cl"><span class="err">➜</span><span class="w"> </span><span class="vg">ipset</span><span class="w"> </span><span class="vg">list</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">pod</span><span class="o">-</span><span class="vg">subnets</span>
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="vg">子网信息</span><span class="p">,</span><span class="w"> </span><span class="vg">即上文的路由信息</span>
</span></span><span class="line"><span class="cl"><span class="nl">Name:</span><span class="w"> </span><span class="vg">kube</span><span class="o">-</span><span class="vg">router</span><span class="o">-</span><span class="vg">pod</span><span class="o">-</span><span class="vg">subnets</span>
</span></span><span class="line"><span class="cl"><span class="nl">Type:</span><span class="w"> </span><span class="nl">hash:</span><span class="vg">net</span>
</span></span><span class="line"><span class="cl"><span class="nl">Revision:</span><span class="w"> </span><span class="il">6</span>
</span></span><span class="line"><span class="cl"><span class="nl">Header:</span><span class="w"> </span><span class="vg">family</span><span class="w"> </span><span class="vg">inet</span><span class="w"> </span><span class="vg">hashsize</span><span class="w"> </span><span class="il">1024</span><span class="w"> </span><span class="vg">maxelem</span><span class="w"> </span><span class="il">65536</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="vg">Size</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="nl">memory:</span><span class="w"> </span><span class="il">736</span>
</span></span><span class="line"><span class="cl"><span class="nl">References:</span><span class="w"> </span><span class="il">2</span>
</span></span><span class="line"><span class="cl"><span class="vg">Number</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="nl">entries:</span><span class="w"> </span><span class="il">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">Members:</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.66.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.68.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">10</span><span class="mf">.233.64.0</span><span class="o">/</span><span class="il">24</span><span class="w"> </span><span class="vg">timeout</span><span class="w"> </span><span class="il">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ipset list kube-router-node-ips
</span></span><span class="line"><span class="cl"><span class="c1"># 节点信息</span>
</span></span><span class="line"><span class="cl">Name: kube-router-node-ips
</span></span><span class="line"><span class="cl">Type: hash:ip
</span></span><span class="line"><span class="cl">Revision: <span class="m">4</span>
</span></span><span class="line"><span class="cl">Header: family inet hashsize <span class="m">1024</span> maxelem <span class="m">65536</span> timeout <span class="m">0</span>
</span></span><span class="line"><span class="cl">Size in memory: <span class="m">488</span>
</span></span><span class="line"><span class="cl">References: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Number of entries: <span class="m">3</span>
</span></span><span class="line"><span class="cl">Members:
</span></span><span class="line"><span class="cl">192.168.50.51 timeout <span class="m">0</span>
</span></span><span class="line"><span class="cl">192.168.50.50 timeout <span class="m">0</span>
</span></span><span class="line"><span class="cl">192.168.50.52 timeout <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="outside到svc到pod">outside到svc到pod</h3>
<img src="http://inksnw.asuscomm.com:3001/blog/通过kube-router学习网络1_6ca604634e8c6403b21587d64077648a.png" alt="image-20230728111722176" style="zoom:50%;" />
<p><strong>iptables策略</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ iptables-save
</span></span><span class="line"><span class="cl">-A POSTROUTING ! -s 10.233.66.0/24 ! -d 10.233.66.0/24 -m ipvs --vdir ORIGINAL --vmethod MASQ -m comment --comment <span class="s2">&#34;这是注释&#34;</span> -j SNAT --to-source 192.168.50.51 --random-fully
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>-A POSTROUTING</code>：这部分表示该规则将被添加（-A）到iptables的POSTROUTING链中。这是在路由决策后对报文进行最后处理的链。</li>
<li><code>! -s 10.233.66.0/24</code>：这部分表示来源IP地址不应该是10.233.66.0/24子网中的任何IP地址。感叹号（!）表示“不是”。</li>
<li><code>! -d 10.233.66.0/24</code>：这部分表示目标IP地址不应该是10.233.66.0/24子网中的任何IP地址。</li>
<li><code>-m ipvs --vdir ORIGINAL --vmethod MASQ</code>：这部分使用了ipvs模块（<code>-m ipvs</code>），并且匹配原始目的地（<code>--vdir ORIGINAL</code>）。<code>--vmethod MASQ</code>表示负载均衡器将使用伪装（MASQUERADE）方法。</li>
<li><code>-j SNAT --to-source 192.168.50.51 --random-fully</code>：如果上述所有条件都满足，那么就执行源地址转换（SNAT），并将源IP地址更改为节点ip: 192.168.50.51。<code>--random-fully</code>选项使得源端口在伪装时完全随机，从而防止并发连接冲突。</li>
</ol>
<h3 id="pod到svc到pod">pod到svc到pod</h3>
<img src="http://inksnw.asuscomm.com:3001/blog/通过kube-router学习网络1_34d789a9a265ed643f9579a7e32f514e.png" alt="image-20230728113136373" style="zoom: 50%;" />
<p>创建示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ kubectl create deployment demo --image<span class="o">=</span>httpd --port<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl">➜ kubectl expose deployment demo
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看网卡信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ip addr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">7: kube-dummy-if: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether 2e:db:66:f1:bb:ab brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.233.0.1/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet 10.233.0.3/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet 10.233.5.92/32 scope link kube-dummy-if
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::2cdb:66ff:fef1:bbab/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到kube-dummy-if上多了一条ip地址, 即svc的地址<code>10.233.5.92</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜ kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
</span></span><span class="line"><span class="cl">demo         ClusterIP   10.233.5.92   &lt;none&gt;        80/TCP    5m9s
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   10.233.0.1    &lt;none&gt;        443/TCP   24h
</span></span></code></pre></td></tr></table>
</div>
</div><p>再通过ipvs规则转发到实际pod的ip</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜ ipvsadm
</span></span><span class="line"><span class="cl">TCP  node2:http rr
</span></span><span class="line"><span class="cl">  -&gt; 10.233.68.8:http             Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再通过路由表知道, 这个ip段应该发到<code>192.168.50.52</code>上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜ route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.50.1    0.0.0.0         UG    100    0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.64.0     192.168.50.50   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">10.233.66.0     0.0.0.0         255.255.255.0   U     0      0        0 kube-bridge
</span></span><span class="line"><span class="cl">10.233.68.0     192.168.50.52   255.255.255.0   UG    0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.0    0.0.0.0         255.255.255.0   U     0      0        0 enp1s0
</span></span><span class="line"><span class="cl">192.168.50.1    0.0.0.0         255.255.255.255 UH    100    0        0 enp1s0
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>192.168.50.52</code>收到后, 即进入了标准的收数据流程</p>

    </div>

    
<footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/cni/">cni</a>
            </div>
        <nav class="post-nav">
            <a class="prev" href="/post/k8s%E6%9B%B4%E6%96%B0crd%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88/">
                <i class="iconfont icon-left"></i>
                <span class="prev-text nav-default">K8s更新crd会发生什么</span>
                <span class="prev-text nav-mobile">上一篇</span>
            </a>
            <a class="next" href="/post/cilium%E5%88%9D%E6%8E%A2/">
                <span class="next-text nav-default">Cilium初探</span>
                <span class="next-text nav-mobile">下一篇</span>
                <i class="iconfont icon-right"></i>
            </a>
        </nav>
    </footer>
</article>
        </div>
        

  

  

  
  

      </div>
    </main>

    <footer id="footer" class="footer">
      
<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy;
    2022 -
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>inksnw</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/slideout/1.0.1/slideout.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>






<script src="/js/scripts.js"></script>


</body>
</html>
